{
  "queryset": {
    "version": "1.0.0",
    "dataSources": [
      {
        "id": "6fdd0b48-1e45-4e00-851d-5104d61e38f9",
        "clusterUri": "https://trd-1ndhfr5utev0h9c43p.z6.kusto.fabric.microsoft.com",
        "type": "Fabric",
        "databaseItemId": "12df0d84-ab68-4e15-804e-a365b743e2f8",
        "databaseItemName": "weather_streaming_data"
      }
    ],
    "tabs": [
      {
        "id": "43b8272b-28c8-4c2d-9301-c24d2113575f",
        "content": "weather_live\n|\n\n// View a representation of the schema as a table with column names, column type, and data type.\nweather_Raw_data\n| getschema\n| project ColumnName,ColumnType\n ",
        "title": "Tab",
        "dataSourceId": "6fdd0b48-1e45-4e00-851d-5104d61e38f9"
      },
      {
        "id": "01e330b3-5dab-4c0e-8ce8-4730ace97b3c",
        "content": ".create table weather_Raw_data(\n    city: string,\n    country: string,\n    lat: real,\n    lon: real,\n    localtime: datetime,\n    temp_c: real,\n    humidity: int,\n    wind_kph: real,\n    uv: real,\n    condition_text: string,\n    us_epa_index: int,\n    ingestion_time_utc: datetime,\n    pm2_5: real,\n    pm10: real,\n    co: real,\n    no2: real,\n    o3: int,\n    so2: real \n)\nwith (folder=\"Bronze\")\n\n\n\n.alter table weather_Raw_data policy ingestiontime true;\n\n.alter-merge table weather_Raw_data policy retention softdelete = 30d;\n\nweather_Raw_data\n| take 100\n\nweather_Raw_data\n| summarize\n    min_temp = min(temp_c),\n    max_temp = max(temp_c),\n    min_humidity = min(humidity),\n    max_humidity = max(humidity),\n    min_uv = min(uv),\n    max_uv = max(uv)\n\n\n.drop table weather_Raw_data;\n\n\n\n\n\n\n",
        "title": "Weather_Bronze_Date",
        "dataSourceId": "6fdd0b48-1e45-4e00-851d-5104d61e38f9"
      },
      {
        "id": "add3cc4e-b9ff-48c0-8491-659fcb3b501c",
        "content": "\n.create-or-alter function with (folder = \"Functions\")\n    TransformWeatherToSilver() {\n     weather_Raw_data\n    | extend\n        city = trim(\" \", city),\n        country = trim(\" \", country),\n        latitude = todouble(lat),\n        longitude = todouble(lon),\n        event_time = localtime,\n        event_date = startofday(localtime),\n        event_hour = toint(datetime_part(\"hour\", localtime)),\n        temp_c = todouble(temp_c),\n        humidity_percent = toint(humidity),\n        wind_kph = todouble(wind_kph),\n        uv_index = todouble(uv),\n        pm2_5 = todouble(pm2_5),\n        pm10 = todouble(pm10),\n        co = todouble(co),\n        no2 = todouble(no2),\n        o3 = todouble(o3),\n        aqi_index = toint(us_epa_index),\n        ingestion_time = todatetime(ingestion_time_utc)\n    | extend\n        uv_band = case(\n              uv_index >= 11,\n              \"Extreme\",\n              uv_index >= 8,\n              \"Very High\",\n              uv_index >= 6,\n              \"High\",\n              uv_index >= 3,\n              \"Moderate\",\n              \"Low\"\n          ),\n        aqi_band = case(\n               aqi_index == 1,\n               \"Good\",\n               aqi_index == 2,\n               \"Moderate\",\n               aqi_index == 3,\n               \"Unhealthy for Sensitive Groups\",\n               aqi_index == 4,\n               \"Unhealthy\",\n               aqi_index == 5,\n               \"Very Unhealthy\",\n               aqi_index == 6,\n               \"Hazardous\",\n               \"Unknown\"\n           )\n    | extend\n        heat_wave_level = case(\n                      temp_c >= 45,\n                      \"Severe Heat Wave\",\n                      temp_c >= 40,\n                      \"Heat Wave\",\n                      temp_c >= 35 and humidity_percent >= 60,\n                      \"High Heat Stress\",\n                      temp_c >= 35,\n                      \"Hot\",\n                      \"Normal\"\n                  )\n    | extend \n        environmental_alert = case(\n                          heat_wave_level == \"Severe Heat Wave\" or aqi_index >= 5,\n                          \"Extreme Risk\",\n                          heat_wave_level == \"Heat Wave\" or aqi_index >= 4 or uv_index >= 8,\n                          \"High Risk\",\n                          heat_wave_level == \"High Heat Stress\" or aqi_index >= 3,\n                          \"Moderate Risk\",\n                          \"Low Risk\"\n                      )\n    | where humidity_percent between (0 .. 100)\n    | where uv_index between (0 .. 15)\n    | where aqi_index between (1 .. 6)\n    | where latitude between (-90 .. 90)\n    | where longitude between (-180 .. 180)\n    | summarize arg_max(ingestion_time, *) by city, event_time\n    | project\n        city,\n        country,\n        latitude,\n        longitude,\n        event_time,\n        event_date,\n        event_hour,\n        temp_c,\n        humidity_percent,\n        wind_kph,\n        uv_index,\n        uv_band,\n        pm2_5,\n        pm10,\n        co,\n        no2,\n        o3,\n        aqi_index,\n        aqi_band,\n        heat_wave_level,\n        environmental_alert,\n        ingestion_time\n    }\n\n\n\n.alter table silver_environment_clean (\n    city: string,\n    country: string,\n    latitude: real,\n    longitude: real,\n    event_time: datetime,\n    event_date: datetime,\n    event_hour: int,\n    temp_c: real,\n    humidity_percent: int,\n    wind_kph: real,\n    uv_index: real,\n    uv_band: string,\n    pm2_5: real,\n    pm10: real,\n    co: real,\n    no2: real,\n    o3: real,\n    aqi_index: int,\n    aqi_band: string,\n    heat_wave_level: string,\n    environmental_alert: string,\n    ingestion_time: datetime\n    )\n    with (folder=\"Silver\")\n\n\n    silver_environment_clean\n| summarize arg_max(event_time, *) by city\n| project\n    city,\n    country,\n    event_time,\n    temp_c,\n    uv_index,\n    aqi_index,\n    aqi_band,\n    heat_wave_level,\n    environmental_alert\n\nsilver_environment_clean\n| summarize arg_max(event_time, *) by city\n| summarize\n    total_cities = count(),\n    high_risk_cities = countif(environmental_alert == \"High Risk\"),\n    extreme_risk_cities = countif(environmental_alert == \"Extreme Risk\"),\n    highest_temperature = max(temp_c),\n    worst_aqi = max(aqi_index)\n\n\nsilver_environment_clean\n| summarize arg_max(event_time, *) by city\n| order by temp_c desc\n| project city, temp_c\n\nsilver_environment_clean\n| where event_time > ago(6h)\n| summarize avg_temp = round(avg(temp_c),0) by city, bin(event_time, 1hr)\n| order by event_time asc;\n\n\nsilver_environment_clean    //top avg aqi by city in a day\n| where event_time >= startofday(now())\n| summarize avg_daily_aqi = round(avg(aqi_index),0) by city\n| order by avg_daily_aqi desc;\n\n\n\n\n.show database weather_streaming_data policy retention\n\n.show table weather_Raw_data policy retention\n\n.show table silver_environment_clean policy  retention \n\nsilver_environment_clean\n| summarize min(event_time), max(event_time)\n\nsilver_environment_clean\n| summarize day_avg = avg(temp_c)\n    by city, bin(event_time, 1d)\n| order by city, event_time\n",
        "title": "weather_Transformations",
        "dataSourceId": "6fdd0b48-1e45-4e00-851d-5104d61e38f9"
      },
      {
        "id": "f6c78365-f9d5-49b0-b069-432ac7d86f49",
        "content": "// IsEnabled (bool) - States if update policy is true - enabled, or false - disabled\n// source (string) - Name of the table that triggers invocation of the update policy\n// Query (string) - A query used to produce data for the update\n// IsTransactional (bool) - States if the update policy is transactional or not, default is false). If transactional and the update policy fails, the source table is not updated.\n// PropagateIngestionProperties (bool) - States if properties specified during ingestion to the source table, such as extent tags and creation time, apply to the target table\n// read more - https://aka.ms/updatepolicy\n\n.alter table silver_environment_clean policy update\n```[{\n    \"IsEnabled\": true,\n    \"Source\": \"weather_Raw_data\",\n    \"Query\": \"TransformWeatherToSilver()\",\n    \"IsTransactional\": false,\n    \"PropagateIngestionProperties\": false\n}]```\n\nsilver_environment_clean\n| take 100",
        "title": "policy",
        "dataSourceId": "6fdd0b48-1e45-4e00-851d-5104d61e38f9"
      },
      {
        "id": "18827f14-c028-4032-979e-9be9e511e9e4",
        "content": "silver_environment_clean\n| summarize arg_max(event_time, *) by city\n",
        "title": "",
        "dataSourceId": "6fdd0b48-1e45-4e00-851d-5104d61e38f9"
      },
      {
        "id": "3933986e-1f1b-4750-91d7-760442cb84f8",
        "content": "silver_environment_clean\n| summarize arg_max(event_time, *) by city\n| project city, temp_c\n| order by temp_c desc\n",
        "title": "",
        "dataSourceId": "6fdd0b48-1e45-4e00-851d-5104d61e38f9"
      },
      {
        "id": "0340a675-0cf3-4e45-97fa-3fec6ed83dd6",
        "content": ".show table silver_environment_clean ingestion mappings\n",
        "title": "",
        "dataSourceId": "6fdd0b48-1e45-4e00-851d-5104d61e38f9"
      }
    ]
  }
}